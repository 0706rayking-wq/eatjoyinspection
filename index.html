<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>饗麻饗辣分店巡視系統</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        @media print { .no-print { display: none !important; } }
        /* 隱藏原生滾動條但保持功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* 文字自動換行與版面修正 */
        .break-words { overflow-wrap: break-word; word-wrap: break-word; word-break: break-all; }
        input, textarea { max-width: 100%; }
        /* 防止手機點擊縮放 */
        select, input, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 全域掛載 Firebase 函數供 React 使用
        window.FB = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove };
        
        // 觸發自定義事件通知 React Firebase SDK 已載入
        window.dispatchEvent(new Event('firebase-sdk-loaded'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        /**
         * --- 配置資訊 ---
         */
        const firebaseConfig = {
            apiKey: "AIzaSyDkrlDh8S8OS5sCj7ZlKr6thQAWM7akcPk",
            authDomain: "audit-system-c631b.firebaseapp.com",
            projectId: "audit-system-c631b",
            storageBucket: "audit-system-c631b.firebasestorage.app",
            messagingSenderId: "160351531948",
            appId: "1:160351531948:web:ba62077ddad5e0cf740009",
            measurementId: "G-3X8YFRYJV7"
        };

        const appId = 'audit-system-v1'; 
        const apiKey = ""; // Gemini API Key will be provided by environment
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";

        const App = () => {
            const [user, setUser] = useState(null);
            const [connError, setConnError] = useState(null);
            const [view, setView] = useState('form');
            const [stores, setStores] = useState([]);
            const [historyRecords, setHistoryRecords] = useState([]);
            const [selectedRecord, setSelectedRecord] = useState(null);
            const [checklistTemplate, setChecklistTemplate] = useState([]);
            
            const [newStoreInput, setNewStoreInput] = useState("");
            const [isAddingStore, setIsAddingStore] = useState(false);
            const [newItemInputs, setNewItemInputs] = useState({});
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [rawInput, setRawInput] = useState("");
            const [prevTaskInput, setPrevTaskInput] = useState("");

            const initialFormData = {
                storeName: "",
                date: new Date().toISOString().split('T')[0],
                supervisor: '',
                shiftStaff: '',
                prevImprovements: [],
                currentDeficiencies: [],
                overallScore: 'A',
                overallComment: '',
                activeChecklist: [],
                photos: []
            };

            const [formData, setFormData] = useState(initialFormData);
            const GRADES = ["A+", "A", "A-", "B+", "B", "B-", "C+", "C", "C-"];

            // 最終評價配色邏輯：A 紅、C 綠
            const getGradeColor = (grade) => {
                if (grade.startsWith('A')) return 'text-red-600';
                if (grade.startsWith('C')) return 'text-green-600';
                return 'text-blue-600';
            };

            // 巡檢項目狀態配色邏輯：優 紅、差 綠
            const getStatusBtnClass = (currentStatus, btnStatus) => {
                if (currentStatus !== btnStatus) return 'bg-slate-100 text-slate-400';
                if (btnStatus === '優') return 'bg-red-600 text-white shadow-xl scale-[1.05] transition-all';
                if (btnStatus === '差') return 'bg-green-600 text-white shadow-xl scale-[1.05] transition-all';
                return 'bg-slate-900 text-white shadow-xl scale-[1.05] transition-all';
            };

            const getReportBadgeClass = (status) => {
                if (status === '優') return 'text-red-600 bg-red-50 border-red-100 font-black';
                if (status === '差') return 'text-green-600 bg-green-50 border-green-100 font-black';
                return 'text-slate-400 bg-slate-50 border-slate-100';
            };

            // --- Firebase 初始化 ---
            const [db, setDb] = useState(null);

            const startConnection = async () => {
                if (!window.FB) return;
                setConnError(null);
                try {
                    const { initializeApp, getAuth, getFirestore, signInAnonymously, onAuthStateChanged } = window.FB;
                    const app = initializeApp(firebaseConfig);
                    const _auth = getAuth(app);
                    const _db = getFirestore(app);
                    setDb(_db);

                    await signInAnonymously(_auth);
                    onAuthStateChanged(_auth, (u) => {
                        if (u) setUser(u);
                        else setConnError("連線驗證失敗");
                    });
                } catch (err) {
                    console.error(err);
                    setConnError("雲端連線失敗: " + err.message);
                }
            };

            useEffect(() => {
                if (window.FB) startConnection();
                else window.addEventListener('firebase-sdk-loaded', startConnection);
            }, []);

            // --- 資料同步 ---
            useEffect(() => {
                if (!user || !db) return;
                const { doc, collection, onSnapshot, setDoc } = window.FB;

                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'stores'), (s) => {
                    if (s.exists()) setStores(s.data().list || []);
                    else setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'stores'), { list: ["南港Lalaport店", "台中三井Lalaport店", "高雄明誠店"] });
                });

                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'template'), (s) => {
                    if (s.exists()) setChecklistTemplate(s.data().items || []);
                });

                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'history'), (snap) => {
                    const records = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                    setHistoryRecords(records.sort((a,b) => (b.createdAt||"").localeCompare(a.createdAt||"")));
                });
            }, [user, db]);

            useEffect(() => {
                if (stores.length > 0 && !formData.storeName) setFormData(p => ({ ...p, storeName: stores[0] }));
                if (view === 'form' && checklistTemplate.length > 0) {
                    setFormData(prev => {
                        const currentStatusMap = new Map(prev.activeChecklist.map(i => [i.id, i.status]));
                        const syncedList = checklistTemplate.map(tempItem => ({
                            ...tempItem,
                            status: currentStatusMap.get(tempItem.id) || '一般'
                        }));
                        return { ...prev, activeChecklist: syncedList };
                    });
                }
            }, [stores, checklistTemplate, view]);

            // --- 邏輯函數 ---
            const handleSaveInspection = async () => {
                if (!user || !db) return;
                if (!formData.supervisor) return alert("請填寫主管姓名");
                try {
                    const docRef = await window.FB.addDoc(window.FB.collection(db, 'artifacts', appId, 'public', 'data', 'history'), { ...formData, createdAt: new Date().toISOString() });
                    setSelectedRecord({ ...formData, id: docRef.id });
                    setView('report');
                    window.scrollTo(0,0);
                    alert("紀錄已成功儲存至雲端");
                } catch (e) { alert("儲存失敗"); }
            };

            const addPrevTask = () => {
                if (!prevTaskInput.trim()) return;
                setFormData(p => ({ ...p, prevImprovements: [...p.prevImprovements, { id: Date.now(), task: prevTaskInput.trim(), status: 'pending' }] }));
                setPrevTaskInput("");
            };

            const addDeficiency = (type) => {
                if (!rawInput.trim()) return;
                setFormData(p => ({ ...p, currentDeficiencies: [...p.currentDeficiencies, { id: Date.now(), task: rawInput.trim(), type }] }));
                setRawInput("");
            };

            const handlePhotoUpload = (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onloadend = () => setFormData(p => ({ ...p, photos: [...p.photos, reader.result] }));
                    reader.readAsDataURL(file);
                });
            };

            // --- ✨ Gemini API 功能 ✨ ---
            const callGemini = async (userPrompt, systemPrompt) => {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
                
                const fetchWithRetry = async (retries = 5, delay = 1000) => {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: userPrompt }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] }
                            })
                        });
                        if (!response.ok) throw new Error(`API Error: ${response.status}`);
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text;
                    } catch (err) {
                        if (retries > 0) {
                            await new Promise(res => setTimeout(res, delay));
                            return fetchWithRetry(retries - 1, delay * 2);
                        }
                        throw err;
                    }
                };
                return fetchWithRetry();
            };

            const handleAiSummary = async (isPolish = false) => {
                setIsAiLoading(true);
                try {
                    const poorItems = formData.activeChecklist.filter(i => i.status === '差').map(i => i.item).join('、');
                    const currentDefs = formData.currentDeficiencies.map(d => `${d.type === 'require' ? '[要求]' : '[建議]'} ${d.task}`).join('\n');
                    const currentComment = formData.overallComment;

                    let systemPrompt = "你是一位資深餐飲集團區域督導，擅長撰寫專業、嚴謹且具建設性的門市巡視報告。語氣要客觀且帶有權威感。";
                    let userPrompt = "";

                    if (isPolish) {
                        userPrompt = `請幫我潤飾這段巡視建議，使其更專業：\n\n${currentComment}`;
                    } else {
                        userPrompt = `
                            請根據以下巡視數據撰寫一段 150 字內的專業督導建議總結：
                            門市：${formData.storeName}
                            巡檢缺失項：${poorItems || '無'}
                            重點改善點：\n${currentDefs || '無'}
                        `;
                    }

                    const result = await callGemini(userPrompt, systemPrompt);
                    if (result) {
                        setFormData(prev => ({ ...prev, overallComment: result.trim() }));
                    }
                } catch (err) {
                    console.error("AI 呼叫失敗", err);
                    alert("AI 功能暫時無法使用，請稍後再試。");
                } finally {
                    setIsAiLoading(false);
                }
            };

            const categories = useMemo(() => [...new Set(checklistTemplate.map(i => i.category))], [checklistTemplate]);

            // --- 視圖渲染 ---
            if (connError) return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-900 text-white p-8 text-center">
                    <div className="text-red-500 mb-4 text-6xl">⚠️</div>
                    <h1 className="text-2xl font-black mb-4">雲端連線失敗</h1>
                    <p className="text-slate-400 mb-8 max-w-md">{connError}</p>
                    <button onClick={startConnection} className="bg-blue-600 px-8 py-3 rounded-2xl font-bold active:scale-95 transition-all">重新連線</button>
                </div>
            );

            if (!user) return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-900 text-white font-black italic text-center p-10">
                    <div className="w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full animate-spin mb-4 mx-auto"></div>
                    <p className="tracking-widest uppercase opacity-60">饗麻饗辣 - Syncing...</p>
                </div>
            );

            if (view === 'manage') return (
                <div className="min-h-screen bg-slate-50 pb-20 text-slate-900">
                    <nav className="bg-slate-900 text-white p-5 sticky top-0 z-50 flex justify-between items-center shadow-xl">
                        <div className="font-black text-xl italic text-red-500">系統設定</div>
                        <button onClick={() => setView('form')} className="bg-blue-600 px-6 py-2 rounded-xl font-bold text-sm">返回首頁</button>
                    </nav>
                    <div className="max-w-xl mx-auto p-4 space-y-8 mt-6">
                        <section className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                            <h2 className="font-black text-slate-800 text-lg mb-4 text-blue-600">門店名單管理</h2>
                            <div className="flex flex-wrap gap-2 mb-4">
                                {stores.map(s => (
                                    <div key={s} className="bg-slate-100 px-3 py-1.5 rounded-lg flex items-center gap-2 border border-slate-200">
                                        <span className="text-sm font-bold text-slate-700">{s}</span>
                                        <button onClick={async () => await window.FB.updateDoc(window.FB.doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'stores'), { list: window.FB.arrayRemove(s) })} className="text-red-400 font-bold text-xs px-1">刪除</button>
                                    </div>
                                ))}
                            </div>
                            {isAddingStore ? (
                                <div className="flex gap-2">
                                    <input autoFocus type="text" className="flex-1 border rounded-xl px-4 py-2 text-sm outline-none focus:border-red-500" value={newStoreInput} onChange={(e) => setNewStoreInput(e.target.value)} placeholder="門店名稱" />
                                    <button onClick={async () => { if(newStoreInput.trim()){ await window.FB.updateDoc(window.FB.doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'stores'), { list: window.FB.arrayUnion(newStoreInput.trim()) }); setNewStoreInput(""); setIsAddingStore(false); } }} className="bg-red-600 text-white px-4 py-2 rounded-xl font-bold">確認</button>
                                </div>
                            ) : <button onClick={() => setIsAddingStore(true)} className="w-full border-2 border-dashed border-slate-200 py-3 rounded-2xl text-slate-400 font-bold text-sm">+ 新增分店</button>}
                        </section>

                        <section className="space-y-4">
                            <h2 className="font-black text-slate-800 text-lg px-2 text-blue-600 border-l-4 border-blue-600 pl-3">巡檢項目編輯</h2>
                            {categories.map(cat => (
                                <div key={cat} className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 space-y-3">
                                    <h3 className="font-black text-blue-500 text-xs uppercase tracking-widest">{cat}</h3>
                                    <div className="space-y-2">
                                        {checklistTemplate.filter(i => i.category === cat).map(item => (
                                            <div key={item.id} className="flex items-start gap-2 group border-b border-slate-50 pb-2">
                                                <p className="flex-1 text-sm font-medium leading-relaxed break-words py-1">{item.item}</p>
                                                <button 
                                                    onClick={async () => {
                                                        if(confirm(`確定刪除項目：「${item.item}」？`)) {
                                                            await window.FB.updateDoc(window.FB.doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'template'), { items: window.FB.arrayRemove(item) });
                                                        }
                                                    }} 
                                                    className="text-red-300 hover:text-red-500 font-bold text-[10px] uppercase shrink-0 py-1"
                                                >刪除</button>
                                            </div>
                                        ))}
                                        <div className="flex gap-2 pt-2">
                                            <input type="text" placeholder="新增項目描述..." className="flex-1 bg-slate-50 border-none rounded-lg px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-blue-200 shadow-inner" value={newItemInputs[cat] || ""} onChange={(e) => setNewItemInputs({ ...newItemInputs, [cat]: e.target.value })} />
                                            <button onClick={async () => { const text = newItemInputs[cat]; if(text && text.trim()){ await window.FB.updateDoc(window.FB.doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'template'), { items: window.FB.arrayUnion({ id: Date.now() + Math.random(), category: cat, item: text.trim() }) }); setNewItemInputs({ ...newItemInputs, [cat]: "" }); } }} className="bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-bold shrink-0">新增</button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </section>
                    </div>
                </div>
            );

            if (view === 'history') return (
                <div className="min-h-screen bg-slate-50 pb-24 text-slate-900">
                    <nav className="bg-slate-900 text-white p-5 sticky top-0 z-50 flex justify-between items-center shadow-xl">
                        <div className="text-blue-400 font-black text-xl italic uppercase tracking-widest">歷史紀錄</div>
                        <button onClick={() => setView('form')} className="bg-slate-800 px-5 py-2 rounded-xl text-sm font-bold">返回首頁</button>
                    </nav>
                    <div className="max-w-2xl mx-auto p-4 space-y-4 mt-4">
                        {historyRecords.length === 0 ? <div className="text-center py-20 text-slate-300 font-bold border-2 border-dashed rounded-3xl uppercase tracking-widest">NO RECORDS</div> : historyRecords.map(r => (
                            <div key={r.id} onClick={() => { setSelectedRecord(r); setView('report'); }} className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 flex justify-between items-center cursor-pointer active:scale-95 transition-all">
                                <div><h4 className="font-black text-lg text-slate-800">{String(r.storeName)}</h4><p className="text-[10px] text-slate-400 font-black uppercase tracking-widest">{String(r.date)} · {String(r.supervisor)}</p></div>
                                <div className="flex items-center gap-4"><div className={`text-2xl font-black ${getGradeColor(r.overallScore)}`}>{String(r.overallScore)}</div><button onClick={(e) => { e.stopPropagation(); if(confirm("確定刪除？")) window.FB.deleteDoc(window.FB.doc(db, 'artifacts', appId, 'public', 'data', 'history', r.id)); }} className="text-slate-300 hover:text-red-500 font-bold text-xs px-2">刪除</button></div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            if (view === 'report' && selectedRecord) {
                const r = selectedRecord;
                const recCategories = [...new Set((r.activeChecklist || []).map(i => i.category))];
                return (
                    <div className="min-h-screen bg-white sm:bg-slate-100 p-0 sm:p-8">
                        <div className="max-w-4xl mx-auto bg-white shadow-2xl overflow-hidden print:shadow-none text-slate-900 border-b-8 border-slate-900">
                            <div className="bg-slate-900 text-white p-10 flex justify-between items-end">
                                <div><h1 className="text-4xl font-black italic uppercase tracking-tighter mb-2 italic uppercase text-white">Audit Report</h1><p className="text-blue-400 font-black tracking-[0.3em] uppercase text-xs">{String(r.storeName)} · {String(r.date)}</p></div>
                                <div className="no-print flex flex-wrap gap-2 justify-end">
                                    <button onClick={() => setView('form')} className="bg-slate-700 px-4 py-2 rounded-lg text-xs font-bold text-white uppercase shadow-md active:scale-95">返回修改</button>
                                    <button onClick={handleSaveInspection} className="bg-blue-500 px-4 py-2 rounded-lg text-xs font-bold text-white uppercase shadow-md active:scale-95">儲存紀錄</button>
                                    <button onClick={() => { setFormData(initialFormData); setView('form'); }} className="bg-slate-800 px-4 py-2 rounded-lg text-xs font-bold text-white uppercase shadow-md active:scale-95">新巡檢</button>
                                    <button onClick={() => window.print()} className="bg-red-600 px-4 py-2 rounded-lg text-xs font-bold text-white flex items-center gap-2 uppercase font-black shadow-md active:scale-95">列印報告</button>
                                </div>
                            </div>
                            <div className="p-10 space-y-12">
                                <div className="grid grid-cols-2 md:grid-cols-4 border divide-x text-slate-700 shadow-sm">
                                    <div className="p-4 bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">營運總監</div><div className="p-4 font-bold">{String(r.supervisor)}</div>
                                    <div className="p-4 bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">當日值班</div><div className="p-4 font-bold">{String(r.shiftStaff)}</div>
                                </div>
                                {r.prevImprovements?.length > 0 && (
                                    <div className="space-y-4">
                                        <h3 className="font-black text-slate-900 text-sm uppercase tracking-widest border-l-4 border-orange-500 pl-3">上期改善進度</h3>
                                        <div className="space-y-2">
                                            {r.prevImprovements.map(item => (
                                                <div key={item.id} className="flex justify-between p-4 bg-slate-50 rounded-xl border border-slate-100 shadow-sm">
                                                    <span className="text-sm font-bold text-slate-700 break-words flex-1 pr-4">{item.task}</span>
                                                    <span className={`text-[10px] font-black px-4 py-1 rounded-full shrink-0 h-fit ${item.status === 'done' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{item.status === 'done' ? '已改善' : '未改善'}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                <div className="space-y-4">
                                    <h3 className="font-black text-slate-900 text-sm uppercase tracking-widest border-l-4 border-red-500 pl-3">本次缺失改善點</h3>
                                    <div className="space-y-2">
                                        {r.currentDeficiencies?.map(d => (
                                            <div key={d.id} className={`p-4 rounded-2xl flex items-center justify-between border ${d.type === 'require' ? 'bg-red-50 border-red-100' : 'bg-blue-50 border-blue-100'} shadow-sm`}>
                                                <span className="text-sm font-bold text-slate-800 break-words flex-1 pr-2">{String(d.task)}</span><span className={`text-[10px] font-black px-3 py-1 rounded-full uppercase shrink-0 ${d.type === 'require' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'}`}>{d.type === 'require' ? '要求改善' : '建議'}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                {r.photos?.length > 0 && (
                                    <div className="space-y-4">
                                        <h3 className="font-black text-slate-900 text-xs tracking-widest uppercase">現場照片存證</h3>
                                        <div className="grid grid-cols-2 gap-4">{r.photos.map((p, i) => <img key={i} src={p} className="w-full aspect-video object-cover rounded-2xl shadow-sm border" />)}</div>
                                    </div>
                                )}
                                <div className="bg-blue-50 border-l-4 border-blue-600 p-8 space-y-2 text-slate-700 shadow-inner"><h3 className="font-black text-blue-900 text-xs uppercase tracking-widest text-blue-800">督導總結建議</h3><p className="leading-relaxed font-bold italic break-words whitespace-pre-wrap">{String(r.overallComment || "當次巡訪狀況優良。")}</p></div>
                                <div className="space-y-8">{recCategories.map(cat => (
                                    <div key={cat} className="space-y-3">
                                        <h3 className="font-black text-slate-400 text-[10px] uppercase tracking-widest border-b pb-2">{String(cat)}</h3>
                                        <div className="divide-y">{(r.activeChecklist || []).filter(i => i.category === cat).map((item, idx) => (
                                            <div key={idx} className="py-3 flex justify-between items-center"><span className="text-sm font-bold text-slate-700 break-words pr-2">{String(item.item)}</span><span className={`text-[10px] font-black px-4 py-1 rounded-full border shrink-0 ${getReportBadgeClass(item.status)}`}>{String(item.status)}</span></div>
                                        ))}</div>
                                    </div>
                                ))}</div>
                                <div className="border-t-4 border-slate-900 pt-8 flex justify-between items-center"><div><h4 className="font-black text-slate-400 text-[10px] uppercase tracking-[0.3em]">本月評價</h4><div className={`text-7xl font-black italic tracking-tighter ${getGradeColor(r.overallScore)}`}>{String(r.overallScore)}</div></div><div className="text-right text-slate-300 font-black italic text-xs uppercase text-slate-300"><p>饗麻饗辣 EATJOY</p><p>ID: {String(r.id?.slice(-6))}</p></div></div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-100 pb-32 font-sans text-slate-900">
                    <nav className="bg-slate-900 text-white p-5 sticky top-0 z-40 flex justify-between items-center shadow-lg">
                        <div className="flex items-center gap-3"><div className="bg-red-600 px-3 py-1 rounded-xl font-black text-sm italic uppercase text-white tracking-widest shadow-md">饗麻饗辣</div></div>
                        <div className="flex gap-2">
                            <button onClick={() => setView('history')} className="bg-slate-800 px-3 sm:px-4 py-2 rounded-xl text-slate-300 font-black text-[10px] sm:text-xs border border-slate-700 active:bg-slate-700 transition-colors">歷史紀錄</button>
                            <button onClick={() => setView('manage')} className="bg-slate-800 px-3 sm:px-4 py-2 rounded-xl text-slate-300 font-black text-[10px] sm:text-xs border border-slate-700 active:bg-slate-700 transition-colors">設定</button>
                            <button onClick={() => setView('report')} className="bg-blue-600 px-4 sm:px-6 py-2 rounded-xl font-black text-[10px] sm:text-xs shadow-xl text-white border border-blue-500 active:bg-blue-500 transition-colors">預覽</button>
                        </div>
                    </nav>

                    <div className="max-w-xl mx-auto p-4 space-y-6 mt-4 overflow-hidden">
                        {/* 基本資訊 */}
                        <section className="bg-white rounded-[2.5rem] p-6 sm:p-8 shadow-sm border border-slate-200 space-y-6">
                            <div className="space-y-4">
                                <div className="flex items-center gap-2 px-1 text-[10px] font-black text-slate-400 uppercase tracking-widest border-l-2 border-blue-500 pl-2 uppercase">Store Info</div>
                                <div className="grid grid-cols-2 gap-3">
                                    <select className="col-span-2 bg-slate-50 border-none rounded-2xl p-4 font-black text-sm outline-none cursor-pointer shadow-inner" value={formData.storeName} onChange={e => setFormData({...formData, storeName: e.target.value})}>
                                        {stores.map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                    <input type="text" placeholder="營運總監" value={formData.supervisor} onChange={e => setFormData({...formData, supervisor: e.target.value})} className="bg-slate-50 border-none rounded-2xl p-4 font-black text-sm outline-none shadow-inner focus:ring-1 focus:ring-red-500" />
                                    <input type="text" placeholder="當日值班" value={formData.shiftStaff} onChange={e => setFormData({...formData, shiftStaff: e.target.value})} className="bg-slate-50 border-none rounded-2xl p-4 font-black text-sm outline-none shadow-inner focus:ring-1 focus:ring-red-500" />
                                </div>
                            </div>
                        </section>

                        {/* 上期缺失追蹤 */}
                        <section className="bg-orange-50 rounded-[2.5rem] p-6 sm:p-8 shadow-sm border border-orange-100 space-y-6 overflow-hidden">
                            <h2 className="font-black text-xs uppercase tracking-widest text-orange-600 flex items-center gap-2">● 上期缺失追蹤</h2>
                            <div className="flex gap-2">
                                <input type="text" placeholder="新增項目..." className="flex-1 min-w-0 bg-white border-none rounded-2xl px-5 py-4 text-sm font-bold outline-none shadow-sm" value={prevTaskInput} onChange={e => setPrevTaskInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && addPrevTask()} />
                                <button onClick={addPrevTask} className="bg-orange-500 text-white px-5 rounded-2xl shadow-lg font-black text-xl flex-shrink-0 active:scale-90 transition-transform">＋</button>
                            </div>
                            <div className="space-y-2 pt-2">
                                {formData.prevImprovements.map(item => (
                                    <div key={item.id} className="bg-white p-4 rounded-2xl flex flex-col gap-3 shadow-sm border border-orange-50 overflow-hidden">
                                        <div className="flex items-start gap-3 break-all">
                                            <span className="text-orange-500 font-black shrink-0 mt-0.5">✓</span>
                                            <span className="text-sm font-bold text-slate-700 break-words">{item.task}</span>
                                        </div>
                                        <div className="flex flex-wrap gap-1">
                                            <button onClick={() => setFormData(p => ({ ...p, prevImprovements: p.prevImprovements.map(i => i.id === item.id ? { ...i, status: 'done' } : i) }))} className={`flex-1 min-w-[80px] px-3 py-2 rounded-xl text-[10px] font-black transition-all ${item.status === 'done' ? 'bg-green-600 text-white shadow-md' : 'bg-slate-100 text-slate-400'}`}>已改善</button>
                                            <button onClick={() => setFormData(p => ({ ...p, prevImprovements: p.prevImprovements.map(i => i.id === item.id ? { ...i, status: 'pending' } : i) }))} className={`flex-1 min-w-[70px] px-3 py-2 rounded-xl text-[10px] font-black transition-all ${item.status === 'pending' ? 'bg-red-500 text-white shadow-md' : 'bg-slate-100 text-slate-400'}`}>未改善</button>
                                            <button onClick={() => setFormData(p => ({ ...p, prevImprovements: p.prevImprovements.filter(i => i.id !== item.id) }))} className="px-3 py-2 text-red-400 font-bold text-xs uppercase hover:text-red-600">刪除</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>

                        {/* 巡檢項目 */}
                        {categories.map((cat) => (
                            <div key={cat} className="space-y-3">
                                <h3 className="font-black text-slate-400 text-[10px] uppercase tracking-[0.3em] px-4 border-l-2 border-slate-300 ml-1">{cat}</h3>
                                <div className="space-y-3">
                                    {formData.activeChecklist.filter(item => item.category === cat).map(item => (
                                        <div key={item.id} className="bg-white rounded-[2rem] p-6 shadow-sm border border-transparent">
                                            <p className="font-bold text-slate-700 text-sm mb-5 leading-relaxed break-words">{item.item}</p>
                                            <div className="flex gap-2">
                                                {['差', '一般', '優'].map(s => (
                                                    <button 
                                                        key={s} 
                                                        onClick={() => setFormData({...formData, activeChecklist: formData.activeChecklist.map(i => i.id === item.id ? {...i, status: s} : i)})} 
                                                        className={`flex-1 py-3.5 rounded-2xl text-[10px] font-black transition-all ${getStatusBtnClass(item.status, s)}`}
                                                    >{s}</button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}

                        <section className="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-200 space-y-6 overflow-hidden">
                            <div className="flex justify-between items-center"><h2 className="font-black text-xs uppercase text-slate-400 flex items-center gap-2">● 本次缺失改善點</h2></div>
                            <textarea className="w-full bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold min-h-[100px] outline-none shadow-inner focus:ring-1 focus:ring-blue-500" placeholder="輸入現場缺失內容，點選下方按鈕加入清單..." value={rawInput} onChange={e => setRawInput(e.target.value)} />
                            <div className="flex flex-wrap gap-2">
                                <button onClick={() => addDeficiency('suggest')} className="flex-1 min-w-[120px] bg-blue-100 text-blue-600 py-3 rounded-xl font-black text-xs active:scale-95 border border-blue-200 hover:bg-blue-200">＋ 建議項目</button>
                                <button onClick={() => addDeficiency('require')} className="flex-1 min-w-[120px] bg-red-100 text-red-600 py-3 rounded-xl font-black text-xs active:scale-95 border border-red-200 hover:bg-red-200">＋ 要求改善</button>
                            </div>
                            <div className="space-y-2 pt-2">
                                {formData.currentDeficiencies.map(d => (
                                    <div key={d.id} className="bg-slate-50 p-4 rounded-2xl flex items-start justify-between group border border-slate-100 text-sm font-bold text-slate-900 shadow-sm">
                                        <div className="flex items-start gap-3 flex-1">
                                            <div className={`w-2 h-2 rounded-full shrink-0 mt-1.5 ${d.type === 'require' ? 'bg-red-500' : 'bg-blue-500'}`} />
                                            <span className="break-all">{d.task}</span>
                                        </div>
                                        <button onClick={() => setFormData({...formData, currentDeficiencies: formData.currentDeficiencies.filter(i => i.id !== d.id)})} className="text-red-500 font-bold text-[10px] uppercase shrink-0 pl-3 hover:text-red-700">刪除</button>
                                    </div>
                                ))}
                            </div>
                        </section>

                        <section className="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-200 space-y-4">
                            <div className="flex justify-between items-center"><h2 className="font-black text-[10px] uppercase text-slate-400 tracking-widest">Photos</h2><label className="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black cursor-pointer shadow-md active:scale-95 hover:bg-slate-800 transition-colors">拍照 / 上傳<input type="file" accept="image/*" multiple className="hidden" onChange={handlePhotoUpload} /></label></div>
                            {formData.photos.length > 0 ? (
                                <div className="grid grid-cols-3 gap-2 pt-2">
                                    {formData.photos.map((p, i) => (
                                        <div key={i} className="relative aspect-square rounded-xl overflow-hidden shadow-sm border"><img src={p} className="w-full h-full object-cover" /><button onClick={() => setFormData({...formData, photos: formData.photos.filter((_, idx) => idx !== i)})} className="absolute top-1 right-1 bg-red-500 text-white w-6 h-6 rounded-full font-black text-[10px] flex items-center justify-center transition-transform active:scale-110 shadow-lg border border-white">X</button></div>
                                    ))}
                                </div>
                            ) : <div className="border-2 border-dashed border-slate-100 rounded-2xl p-8 text-center text-slate-300 text-xs font-bold italic tracking-widest uppercase">No Photos Found</div>}
                        </section>

                        {/* --- ✨ AI 建議區塊 ✨ --- */}
                        <section className="bg-slate-900 rounded-[3rem] p-10 space-y-8 text-white shadow-2xl relative overflow-hidden border-t-8 border-red-600">
                            <div className="text-center space-y-2 relative">
                                <h2 className="font-black text-[10px] text-slate-400 uppercase tracking-[0.3em]">本月評價</h2>
                                <select className={`bg-transparent text-7xl font-black outline-none appearance-none text-center w-full cursor-pointer italic ${getGradeColor(formData.overallScore)} transition-colors`} value={formData.overallScore} onChange={e => setFormData({...formData, overallScore: e.target.value})}>
                                    {GRADES.map(g => <option key={g} value={g} className="bg-slate-800 text-white">{g}</option>)}
                                </select>
                            </div>
                            
                            <div className="space-y-4 relative">
                                <div className="flex flex-col sm:flex-row gap-2 justify-between items-start sm:items-center px-1">
                                    <label className="text-[10px] font-black text-slate-300 uppercase tracking-widest">督導總結建議</label>
                                    <div className="flex gap-2 w-full sm:w-auto">
                                        <button 
                                            onClick={() => handleAiSummary(false)} 
                                            disabled={isAiLoading} 
                                            className="flex-1 bg-red-600 text-white px-3 py-2 rounded-xl text-[10px] font-bold border border-red-400 uppercase shadow-lg active:scale-95 transition-all hover:bg-red-500 disabled:opacity-50"
                                        >
                                            {isAiLoading ? "⏳ 分析中..." : "✨ AI 自動生成 ✨"}
                                        </button>
                                        <button 
                                            onClick={() => handleAiSummary(true)} 
                                            disabled={isAiLoading || !formData.overallComment} 
                                            className="flex-1 bg-slate-700 text-white px-3 py-2 rounded-xl text-[10px] font-bold border border-slate-600 uppercase shadow-lg active:scale-95 transition-all hover:bg-slate-600 disabled:opacity-50"
                                        >
                                            ✨ AI 專業潤稿 ✨
                                        </button>
                                    </div>
                                </div>
                                <textarea 
                                    className="w-full bg-slate-800 border border-slate-700 rounded-3xl p-6 text-sm font-bold text-white min-h-[180px] outline-none focus:border-red-500 placeholder-slate-500 shadow-inner leading-relaxed" 
                                    placeholder="請點選上方按鈕由 AI 生成專業建議，或手動輸入對該門店的觀察與改進要求..." 
                                    value={formData.overallComment} 
                                    onChange={e => setFormData({...formData, overallComment: e.target.value})} 
                                />
                            </div>
                            <button onClick={handleSaveInspection} className="w-full bg-white text-slate-900 py-6 rounded-[2rem] font-black text-xl shadow-xl active:scale-95 uppercase italic hover:bg-slate-50 transition-all">產出完整報告並儲存</button>
                        </section>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
