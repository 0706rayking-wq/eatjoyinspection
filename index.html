<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>饗麻饗辣分店巡視系統</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        @media print { .no-print { display: none !important; } }
        /* 隱藏原生滾動條但保持功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 全域掛載 Firebase 函數供 React 使用
        window.FB = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove };
        
        // 觸發自定義事件通知 React Firebase SDK 已載入
        window.dispatchEvent(new Event('firebase-sdk-loaded'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        /**
         * --- Firebase 配置 (已寫入您的金鑰) ---
         */
        const firebaseConfig = {
            apiKey: "AIzaSyDkrlDh8S8OS5sCj7ZlKr6thQAWM7akcPk",
            authDomain: "audit-system-c631b.firebaseapp.com",
            projectId: "audit-system-c631b",
            storageBucket: "audit-system-c631b.firebasestorage.app",
            messagingSenderId: "160351531948",
            appId: "1:160351531948:web:ba62077ddad5e0cf740009",
            measurementId: "G-3X8YFRYJV7"
        };

        const appId = 'audit-system-v1'; // 固定的 App ID
        const apiKey = ""; // Gemini API Key (選填)
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";

        const App = () => {
            const [user, setUser] = useState(null);
            const [connError, setConnError] = useState(null);
            const [view, setView] = useState('form');
            const [stores, setStores] = useState([]);
            const [historyRecords, setHistoryRecords] = useState([]);
            const [selectedRecord, setSelectedRecord] = useState(null);
            const [checklistTemplate, setChecklistTemplate] = useState([]);
            
            const [newStoreInput, setNewStoreInput] = useState("");
            const [isAddingStore, setIsAddingStore] = useState(false);
            const [newItemInputs, setNewItemInputs] = useState({});
            const [isGeneratingSummary, setIsGeneratingSummary] = useState(false);
            const [rawInput, setRawInput] = useState("");
            const [prevTaskInput, setPrevTaskInput] = useState("");

            const initialFormData = {
                storeName: "",
                date: new Date().toISOString().split('T')[0],
                supervisor: '',
                shiftStaff: '',
                prevImprovements: [],
                currentDeficiencies: [],
                overallScore: 'A',
                overallComment: '',
                activeChecklist: [],
                photos: []
            };

            const [formData, setFormData] = useState(initialFormData);
            const GRADES = ["A+", "A", "A-", "B+", "B", "B-", "C+", "C", "C-"];

            // --- Firebase 初始化邏輯 ---
            const [db, setDb] = useState(null);

            const startConnection = async () => {
                if (!window.FB) return;
                setConnError(null);
                try {
                    const { initializeApp, getAuth, getFirestore, signInAnonymously, onAuthStateChanged } = window.FB;
                    const app = initializeApp(firebaseConfig);
                    const _auth = getAuth(app);
                    const _db = getFirestore(app);
                    setDb(_db);

                    await signInAnonymously(_auth);
                    onAuthStateChanged(_auth, (u) => {
                        if (u) setUser(u);
                        else setConnError("連線驗證失敗");
                    });
                } catch (err) {
                    console.error(err);
                    setConnError("雲端連線失敗: " + err.message);
                }
            };

            useEffect(() => {
                if (window.FB) startConnection();
                else window.addEventListener('firebase-sdk-loaded', startConnection);
            }, []);

            // --- 雲端資料同步 ---
            useEffect(() => {
                if (!user || !db) return;
                const { doc, collection, onSnapshot, setDoc } = window.FB;

                // 1. 同步門店
                const unsubStores = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'stores'), (s) => {
                    if (s.exists()) setStores(s.data().list);
                    else setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'stores'), { list: ["南港Lalaport店", "台中三井Lalaport店", "高雄明誠店"] });
                }, (err) => setConnError("權限錯誤: 請檢查 Firebase Firestore 規則。"));

                // 2. 同步 72 項巡檢題目
                const unsubTemplate = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'template'), (s) => {
                    if (s.exists()) setChecklistTemplate(s.data().items);
                    else {
                        const fullTemplate = [
                            { id: 1, category: '結帳作業流程', item: '結帳前再次與顧客確認用餐人數及消費總金額' },
                            { id: 2, category: '結帳作業流程', item: '結帳前確認顧客是否有會員(Ocard、百貨)' },
                            { id: 3, category: '結帳作業流程', item: '結帳前詢問顧客是否需要使用(共通載具、統編)' },
                            { id: 4, category: '結帳作業流程', item: '結帳時確認刷卡及找零金額是否無誤' },
                            { id: 5, category: '結帳作業流程', item: '結帳時話術與禮儀是否得宜' },
                            { id: 6, category: '結帳作業流程', item: '櫃檯人員接待禮儀及話術是否得宜' },
                            { id: 7, category: '結帳作業流程', item: 'INLINE 系統控管是否得宜' },
                            { id: 8, category: '門店之環境整潔', item: '入口門面、接客檯面、LOGO乾淨清潔無污' },
                            { id: 9, category: '門店之環境整潔', item: '落地窗及窗台擦拭明亮乾淨無髒污' },
                            { id: 10, category: '門店之環境整潔', item: '櫃內區域日光燈相關設備無閃爍' },
                            { id: 11, category: '門店之環境整潔', item: '櫃內區域天花板乾淨無髒污或蜘蛛網' },
                            { id: 12, category: '門店之環境整潔', item: '櫃內地板清潔無明顯污漬及水痕' },
                            { id: 13, category: '門店之環境整潔', item: '餐具及食用品未直接置於地面上' },
                            { id: 14, category: '門店之環境整潔', item: '櫃位走道保持暢通，顧客可無礙通行' },
                            { id: 15, category: '門店之環境整潔', item: '櫃位環境整體乾淨清潔無髒污' },
                            { id: 16, category: '門店之環境整潔', item: '櫃檯內設備維護保養及乾淨無髒污' },
                            { id: 17, category: '門店之環境整潔', item: '貨架、展示架清潔無髒污' },
                            { id: 18, category: '門店之環境整潔', item: '服務櫃台無雜物堆放且物品整齊擺放' },
                            { id: 19, category: '門店之環境整潔', item: '展示張貼物或宣傳海報無破損' },
                            { id: 20, category: '門店之環境整潔', item: '展示張貼物或指示牌外觀保持整潔' },
                            { id: 21, category: '門店之環境整潔', item: '菜單(本)或電視牆展示清潔無虞' },
                            { id: 22, category: '門店之環境整潔', item: '特殊節日價格明顯標示清楚' },
                            { id: 23, category: '門店之環境整潔', item: '商品名稱與菜單內容相符(肉/海鮮/熟食/甜點)' },
                            { id: 24, category: '門店之環境整潔', item: '音樂音量適當並於規定時間開啟' },
                            { id: 25, category: '門店之環境整潔', item: '設備使用符合公司規範' },
                            { id: 26, category: '門店之環境整潔', item: '冷氣溫度適當(無過冷或過熱)' },
                            { id: 27, category: '門店之環境整潔', item: '季節性裝飾擺放恰當、美觀、整齊' },
                            { id: 28, category: '各區域之環境整潔', item: '醬料檯面及櫃下環境清潔，營業中保持乾淨' },
                            { id: 29, category: '各區域之環境整潔', item: '飲料檯面及櫃下環境清潔，營業中保持乾淨' },
                            { id: 30, category: '各區域之環境整潔', item: '甜點檯面及櫃下環境清潔，營業中保持乾淨' },
                            { id: 31, category: '各區域之環境整潔', item: '熟食檯面及櫃下環境清潔，營業中保持乾淨' },
                            { id: 32, category: '各區域之環境整潔', item: '海鮮檯面及櫃下環境清潔無異味' },
                            { id: 33, category: '各區域之環境整潔', item: '廁所依時間表落實檢查並清潔' },
                            { id: 34, category: '各區域之環境整潔', item: '洗滌區域環境清潔，依表落實執行複檢' },
                            { id: 35, category: '各區域之環境整潔', item: '外場區域環境清潔，依表落實執行複檢' },
                            { id: 36, category: '各區域之環境整潔', item: '倉儲區域環境清潔，依表落實執行複檢' },
                            { id: 37, category: '各區域之環境整潔', item: '戶外區域環境清潔，依表落實執行複檢' },
                            { id: 38, category: '物料管理及倉儲管理', item: '備貨量適中，有效提供顧客需求' },
                            { id: 39, category: '物料管理及倉儲管理', item: '耗材使用合理，無過度消耗及浪費' },
                            { id: 40, category: '物料管理及倉儲管理', item: '食材落實先進先出原則' },
                            { id: 41, category: '物料管理及倉儲管理', item: '倉儲管理得宜，區域規劃明確' },
                            { id: 42, category: '設備保養及維護', item: '軟水機設備定期保養更換，保持整潔' },
                            { id: 43, category: '設備保養及維護', item: '冷氣機設備定期刷洗及檢查' },
                            { id: 44, category: '設備保養及維護', item: '散熱水塔設備定期刷洗及檢查' },
                            { id: 45, category: '設備保養及維護', item: '濾心設備定期保養更換及檢查' },
                            { id: 46, category: '設備保養及維護', item: '飲料機台設備定期刷洗及檢查' },
                            { id: 47, category: '菜色呈現及出餐品質', item: '菜品名牌樣式統一，乾淨整齊' },
                            { id: 48, category: '菜色呈現及出餐品質', item: '菜品名稱與當下菜品內容一致' },
                            { id: 49, category: '菜色呈現及出餐品質', item: '菜品呈現擺盤乾淨整齊，令人有食欲' },
                            { id: 50, category: '菜色呈現及出餐品質', item: '菜品出餐前皆有試吃，確保品質' },
                            { id: 51, category: '菜色呈現及出餐品質', item: '冰淇淋口味多，名牌一致無過多重疊' },
                            { id: 52, category: '菜色呈現及出餐品質', item: '冰品蛋糕呈現乾淨整齊，令人有食欲' },
                            { id: 53, category: '菜色呈現及出餐品質', item: '蝦缸及時撈除死蝦，溫度設定正確' },
                            { id: 54, category: '菜色呈現及出餐品質', item: '出餐效率良好，能準時出餐' },
                            { id: 55, category: '教育訓練進度及培訓計畫', item: '幹部明確規劃人員訓練進程' },
                            { id: 56, category: '教育訓練進度及培訓計畫', item: '幹部清楚每位人員職能及訓練進度' },
                            { id: 57, category: '教育訓練進度及培訓計畫', item: '幹部在訓練時能給予適時建議及想法' },
                            { id: 58, category: '教育訓練進度及培訓計畫', item: '幹部交辦任務後持續追蹤及複查' },
                            { id: 59, category: '教育訓練進度及培訓計畫', item: '幹部以身作則按照公司制度實施' },
                            { id: 60, category: '教育訓練進度及培訓計畫', item: '正職人員依標準流程指導新人並提供反饋' },
                            { id: 61, category: '服裝儀容及基本服務應對', item: '顧客入店及時招呼及迎賓話術' },
                            { id: 62, category: '服裝儀容及基本服務應對', item: '顧客離店提供歡送用語' },
                            { id: 63, category: '服裝儀容及基本服務應對', item: '人員忙碌時能使用禮貌用語眼神示意稍等' },
                            { id: 64, category: '服裝儀容及基本服務應對', item: '與顧客互動目光正視，面帶微笑' },
                            { id: 65, category: '服裝儀容及基本服務應對', item: '人員說話聲音輕柔，音調上揚得宜' },
                            { id: 66, category: '服裝儀容及基本服務應對', item: '用餐方式介紹清晰、說明完整、語速適中' },
                            { id: 67, category: '服裝儀容及基本服務應對', item: '站姿保持正確待機姿勢，無歪斜靠櫃行為' },
                            { id: 68, category: '服裝儀容及基本服務應對', item: '帶位指引注意腳步提醒，手勢正確' },
                            { id: 69, category: '服裝儀容及基本服務應對', item: '雙手遞交商品或結帳物給顧客' },
                            { id: 70, category: '服裝儀容及基本服務應對', item: '現場無飲食、滑手機、大聲喧嘩等不當行為' },
                            { id: 71, category: '服裝儀容及基本服務應對', item: '使用正確尊稱(先生/小姐)，禮貌用語得體' },
                            { id: 72, category: '服裝儀容及基本服務應對', item: '著裝規定符合標準，妝髮整潔紮馬尾/夾起' },
                            { id: 73, category: '服裝儀容及基本服務應對', item: '保持手部清潔，無隨意佩戴非規定手套' }
                        ];
                        setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'template'), { items: fullTemplate });
                    }
                });

                // 3. 同步歷史紀錄
                const unsubHistory = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'history'), (snap) => {
                    const records = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                    setHistoryRecords(records.sort((a,b) => (b.createdAt||"").localeCompare(a.createdAt||"")));
                });

                return () => { unsubStores(); unsubTemplate(); unsubHistory(); };
            }, [user, db]);

            useEffect(() => {
                if (stores.length > 0 && !formData.storeName) setFormData(p => ({ ...p, storeName: stores[0] }));
                if (view === 'form' && checklistTemplate.length > 0) {
                    setFormData(prev => {
                        const currentStatusMap = new Map(prev.activeChecklist.map(i => [i.id, i.status]));
                        const syncedList = checklistTemplate.map(tempItem => ({
                            ...tempItem,
                            status: currentStatusMap.get(tempItem.id) || '一般'
                        }));
                        return { ...prev, activeChecklist: syncedList };
                    });
                }
            }, [stores, checklistTemplate, view]);

            // --- 邏輯函數 ---
            const handleSaveInspection = async () => {
                if (!user || !db) return;
                if (!formData.supervisor) return alert("請填寫主管姓名");
                try {
                    const docRef = await window.FB.addDoc(window.FB.collection(db, 'artifacts', appId, 'public', 'data', 'history'), { ...formData, createdAt: new Date().toISOString() });
                    setSelectedRecord({ ...formData, id: docRef.id });
                    setView('report');
                    window.scrollTo(0,0);
                } catch (e) { alert("儲存失敗"); }
            };

            const addPrevTask = () => {
                if (!prevTaskInput.trim()) return;
                setFormData(p => ({ ...p, prevImprovements: [...p.prevImprovements, { id: Date.now(), task: prevTaskInput.trim(), status: 'pending' }] }));
                setPrevTaskInput("");
            };

            const addDeficiency = (type) => {
                if (!rawInput.trim()) return;
                setFormData(p => ({ ...p, currentDeficiencies: [...p.currentDeficiencies, { id: Date.now(), task: rawInput.trim(), type }] }));
                setRawInput("");
            };

            const handlePhotoUpload = (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onloadend = () => setFormData(p => ({ ...p, photos: [...p.photos, reader.result] }));
                    reader.readAsDataURL(file);
                });
            };

            const handleAiGenerateSummary = async () => {
                if (!apiKey) return alert("請填寫 Gemini API Key");
                setIsGeneratingSummary(true);
                const badItems = formData.activeChecklist.filter(i => i.status === '差').map(i => i.item).join('、');
                const defs = formData.currentDeficiencies.map(d => `[${d.type === 'require' ? '要求' : '建議'}] ${d.task}`).join('\n');
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `門市：${formData.storeName}\n缺失：${badItems}\n紀錄：${defs}\n撰寫100字內督導建議。` }] }],
                            systemInstruction: { parts: [{ text: "資深餐飲督導。" }] }
                        })
                    });
                    const result = await response.json();
                    setFormData(p => ({ ...p, overallComment: result.candidates?.[0]?.content?.parts?.[0]?.text || "完成。" }));
                } catch (e) { console.error(e); }
                setIsGeneratingSummary(false);
            };

            const categories = useMemo(() => [...new Set(checklistTemplate.map(i => i.category))], [checklistTemplate]);

            // --- 視圖渲染 ---
            if (connError) return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-900 text-white p-8 text-center">
                    <div className="text-red-500 mb-4 text-6xl">⚠️</div>
                    <h1 className="text-2xl font-black mb-4">雲端連線失敗</h1>
                    <p className="text-slate-400 mb-8 max-w-md">{connError}</p>
                    <button onClick={startConnection} className="bg-blue-600 px-8 py-3 rounded-2xl font-bold">重新嘗試連線</button>
                </div>
            );

            if (!user) return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-900 text-white font-black italic">
                    <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="tracking-widest animate-pulse uppercase">Connecting to Cloud...</p>
                </div>
            );

            if (view === 'manage') return (
                <div className="min-h-screen bg-slate-50 pb-20">
                    <nav className="bg-slate-900 text-white p-5 sticky top-0 z-50 flex justify-between items-center shadow-xl">
                        <div className="font-black text-xl italic text-blue-400">系統設定</div>
                        <button onClick={() => setView('form')} className="bg-blue-600 px-6 py-2 rounded-xl font-bold">返回首頁</button>
                    </nav>
                    <div className="max-w-xl mx-auto p-4 space-y-8 mt-6">
                        <section className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                            <h2 className="font-black text-slate-800 text-lg mb-4">門店管理</h2>
                            <div className="flex flex-wrap gap-2 mb-4">
                                {stores.map(s => (
                                    <div key={s} className="bg-slate-100 px-3 py-1.5 rounded-lg flex items-center gap-2 border border-slate-200">
                                        <span className="text-sm font-bold text-slate-700">{s}</span>
                                        <button onClick={async () => await window.FB.updateDoc(window.FB.doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'stores'), { list: window.FB.arrayRemove(s) })} className="text-red-400 font-bold text-xs">刪除</button>
                                    </div>
                                ))}
                            </div>
                            {isAddingStore ? (
                                <div className="flex gap-2">
                                    <input autoFocus type="text" className="flex-1 border rounded-xl px-4 py-2 text-sm outline-none" value={newStoreInput} onChange={(e) => setNewStoreInput(e.target.value)} />
                                    <button onClick={async () => { if(newStoreInput.trim()){ await window.FB.updateDoc(window.FB.doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'stores'), { list: window.FB.arrayUnion(newStoreInput.trim()) }); setNewStoreInput(""); setIsAddingStore(false); } }} className="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold">確認</button>
                                </div>
                            ) : <button onClick={() => setIsAddingStore(true)} className="w-full border-2 border-dashed border-slate-200 py-3 rounded-2xl text-slate-400 font-bold text-sm">+ 新增分店</button>}
                        </section>
                        <section className="space-y-4">
                            <h2 className="font-black text-slate-800 text-lg px-2 text-blue-500">題目編輯</h2>
                            {categories.map(cat => (
                                <div key={cat} className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 space-y-3">
                                    <h3 className="font-black text-blue-500 text-xs uppercase">{cat}</h3>
                                    <div className="space-y-2">
                                        {checklistTemplate.filter(i => i.category === cat).map(item => (
                                            <div key={item.id} className="flex items-center gap-2 group">
                                                <p className="flex-1 bg-slate-50 rounded-lg px-3 py-2 text-sm font-medium">{item.item}</p>
                                                <button onClick={async () => await window.FB.updateDoc(window.FB.doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'template'), { items: window.FB.arrayRemove(item) })} className="text-red-300 font-bold text-xs px-2">刪除</button>
                                            </div>
                                        ))}
                                        <div className="flex gap-2 pt-2">
                                            <input type="text" placeholder="新增..." className="flex-1 bg-slate-50 border-none rounded-lg px-3 py-2 text-xs" 
                                                value={newItemInputs[cat] || ""} 
                                                onChange={(e) => setNewItemInputs({ ...newItemInputs, [cat]: e.target.value })} />
                                            <button onClick={async () => { const text = newItemInputs[cat]; if(text && text.trim()){ await window.FB.updateDoc(window.FB.doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'template'), { items: window.FB.arrayUnion({ id: Date.now()+Math.random(), category: cat, item: text.trim() }) }); setNewItemInputs({ ...newItemInputs, [cat]: "" }); } }} className="bg-slate-900 text-white px-3 py-2 rounded-lg text-xs font-bold">新增</button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </section>
                    </div>
                </div>
            );

            if (view === 'history') return (
                <div className="min-h-screen bg-slate-50 pb-24">
                    <nav className="bg-slate-900 text-white p-5 sticky top-0 z-50 flex justify-between items-center shadow-xl">
                        <div className="text-blue-400 font-black text-xl italic uppercase tracking-widest">歷史紀錄</div>
                        <button onClick={() => setView('form')} className="bg-slate-800 px-5 py-2 rounded-xl text-sm font-bold">返回首頁</button>
                    </nav>
                    <div className="max-w-2xl mx-auto p-4 space-y-4 mt-4">
                        {historyRecords.length === 0 ? <div className="text-center py-20 text-slate-300 font-bold border-2 border-dashed rounded-3xl">尚無紀錄</div> : historyRecords.map(r => (
                            <div key={r.id} onClick={() => { setSelectedRecord(r); setView('report'); }} className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 flex justify-between items-center cursor-pointer active:scale-95">
                                <div><h4 className="font-black text-lg text-slate-800">{String(r.storeName)}</h4><p className="text-[10px] text-slate-400 font-black uppercase">{String(r.date)} · {String(r.supervisor)}</p></div>
                                <div className="flex items-center gap-4"><div className="text-2xl font-black text-blue-600">{String(r.overallScore)}</div><button onClick={(e) => { e.stopPropagation(); if(confirm("確定刪除？")) window.FB.deleteDoc(window.FB.doc(db, 'artifacts', appId, 'public', 'data', 'history', r.id)); }} className="text-slate-300 hover:text-red-500 font-bold text-xs px-2">刪除</button></div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            if (view === 'report' && selectedRecord) {
                const r = selectedRecord;
                const recCategories = [...new Set((r.activeChecklist || []).map(i => i.category))];
                return (
                    <div className="min-h-screen bg-white sm:bg-slate-100 p-0 sm:p-8">
                        <div className="max-w-4xl mx-auto bg-white shadow-2xl overflow-hidden print:shadow-none text-slate-900 border-b-8 border-slate-900">
                            <div className="bg-slate-900 text-white p-10 flex justify-between items-end">
                                <div><h1 className="text-4xl font-black italic uppercase tracking-tighter mb-2 italic uppercase">Audit Report</h1><p className="text-blue-400 font-black tracking-[0.3em] uppercase text-xs">{String(r.storeName)} · {String(r.date)}</p></div>
                                <div className="no-print flex gap-2">
                                    <button onClick={() => { setFormData(initialFormData); setView('form'); }} className="bg-slate-800 px-4 py-2 rounded-lg text-xs font-bold text-white uppercase italic">新巡檢</button>
                                    <button onClick={() => window.print()} className="bg-blue-600 px-4 py-2 rounded-lg text-xs font-bold text-white flex items-center gap-2 uppercase italic font-black">列印報告</button>
                                </div>
                            </div>
                            <div className="p-10 space-y-12">
                                <div className="grid grid-cols-2 md:grid-cols-4 border divide-x text-slate-700">
                                    <div className="p-4 bg-slate-50 text-[10px] font-black text-slate-400 uppercase">督導</div><div className="p-4 font-bold">{String(r.supervisor)}</div>
                                    <div className="p-4 bg-slate-50 text-[10px] font-black text-slate-400 uppercase">值班</div><div className="p-4 font-bold">{String(r.shiftStaff)}</div>
                                </div>
                                {r.prevImprovements?.length > 0 && (
                                    <div className="space-y-4">
                                        <h3 className="font-black text-slate-900 text-sm uppercase tracking-widest border-l-4 border-orange-500 pl-3">上期改善進度</h3>
                                        <div className="space-y-2">
                                            {r.prevImprovements.map(item => (
                                                <div key={item.id} className="flex justify-between p-4 bg-slate-50 rounded-xl border border-slate-100">
                                                    <span className="text-sm font-bold text-slate-700">{item.task}</span>
                                                    <span className={`text-[10px] font-black px-4 py-1 rounded-full ${item.status === 'done' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{item.status === 'done' ? '已改善' : '未改善'}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                <div className="space-y-4">
                                    <h3 className="font-black text-slate-900 text-sm uppercase tracking-widest border-l-4 border-red-500 pl-3">本次缺失項目</h3>
                                    <div className="space-y-2">
                                        {r.currentDeficiencies?.map(d => (
                                            <div key={d.id} className={`p-4 rounded-2xl flex items-center justify-between border ${d.type === 'require' ? 'bg-red-50 border-red-100' : 'bg-blue-50 border-blue-100'}`}>
                                                <span className="text-sm font-bold text-slate-800">{String(d.task)}</span><span className={`text-[10px] font-black px-3 py-1 rounded-full uppercase ${d.type === 'require' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'}`}>{d.type === 'require' ? '要求' : '建議'}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                {r.photos?.length > 0 && (
                                    <div className="space-y-4">
                                        <h3 className="font-black text-slate-900 text-xs tracking-widest uppercase">現場照片</h3>
                                        <div className="grid grid-cols-2 gap-4">{r.photos.map((p, i) => <img key={i} src={p} className="w-full aspect-video object-cover rounded-2xl shadow-sm border" />)}</div>
                                    </div>
                                )}
                                <div className="bg-blue-50 border-l-4 border-blue-600 p-8 space-y-2 text-slate-700 font-bold italic">{String(r.overallComment || "狀況良好。")}</div>
                                <div className="space-y-8">{recCategories.map(cat => (
                                    <div key={cat} className="space-y-3">
                                        <h3 className="font-black text-slate-400 text-[10px] uppercase border-b pb-2">{String(cat)}</h3>
                                        <div className="divide-y">{(r.activeChecklist || []).filter(i => i.category === cat).map((item, idx) => (
                                            <div key={idx} className="py-3 flex justify-between items-center"><span className="text-sm font-bold text-slate-700">{String(item.item)}</span><span className={`text-[10px] font-black px-4 py-1 rounded-full ${item.status === '優' ? 'text-green-600 bg-green-50' : item.status === '差' ? 'text-red-600 bg-red-50' : 'text-slate-400 bg-slate-50'}`}>{String(item.status)}</span></div>
                                        ))}</div>
                                    </div>
                                ))}</div>
                                <div className="border-t-4 border-slate-900 pt-8 flex justify-between items-center"><div><h4 className="font-black text-slate-400 text-[10px] uppercase">Final Grade</h4><div className="text-7xl font-black text-blue-600 italic tracking-tighter">{String(r.overallScore)}</div></div><div className="text-right text-slate-300 font-black italic text-xs uppercase"><p>Cloud Audit System</p><p>ID: {String(r.id?.slice(-6))}</p></div></div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-100 pb-32 font-sans text-slate-900">
                    <nav className="bg-slate-900 text-white p-5 sticky top-0 z-40 flex justify-between items-center shadow-lg">
                        <div className="flex items-center gap-3"><div className="bg-red-600 px-3 py-1 rounded-xl font-black text-sm italic uppercase text-white tracking-widest">饗麻饗辣分店巡視</div></div>
                        <div className="flex gap-2">
                            <button onClick={() => setView('history')} className="bg-slate-800 px-4 py-2 rounded-xl text-slate-300 font-black text-xs border border-slate-700 uppercase">歷史紀錄</button>
                            <button onClick={() => setView('manage')} className="bg-slate-800 px-4 py-2 rounded-xl text-slate-300 font-black text-xs border border-slate-700 uppercase">設定</button>
                            <button onClick={handleSaveInspection} className="bg-blue-600 px-6 py-2 rounded-xl font-black text-sm shadow-xl text-white border border-blue-500 uppercase">儲存</button>
                        </div>
                    </nav>

                    <div className="max-w-xl mx-auto p-4 space-y-6 mt-4">
                        <section className="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-200 space-y-6">
                            <div className="space-y-4">
                                <div className="flex items-center gap-2 px-1 text-[10px] font-black text-slate-400 uppercase tracking-widest border-l-2 border-blue-500 pl-2 uppercase">Store Info</div>
                                <div className="grid grid-cols-2 gap-3">
                                    <select className="col-span-2 bg-slate-50 border-none rounded-2xl p-4 font-black text-sm outline-none cursor-pointer" value={formData.storeName} onChange={e => setFormData({...formData, storeName: e.target.value})}>
                                        {stores.map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                    <input type="text" placeholder="營運總監" value={formData.supervisor} onChange={e => setFormData({...formData, supervisor: e.target.value})} className="bg-slate-50 border-none rounded-2xl p-4 font-black text-sm outline-none" />
                                    <input type="text" placeholder="當日值班" value={formData.shiftStaff} onChange={e => setFormData({...formData, shiftStaff: e.target.value})} className="bg-slate-50 border-none rounded-2xl p-4 font-black text-sm outline-none" />
                                </div>
                            </div>
                        </section>

                        <section className="bg-orange-50 rounded-[2.5rem] p-8 shadow-sm border border-orange-100 space-y-6">
                            <h2 className="font-black text-xs uppercase tracking-widest text-orange-600 flex items-center gap-2">● 上期缺失追蹤</h2>
                            <div className="flex gap-2">
                                <input type="text" placeholder="新增追蹤項目..." className="flex-1 bg-white border-none rounded-2xl px-5 py-4 text-sm font-bold outline-none" value={prevTaskInput} onChange={e => setPrevTaskInput(e.target.value)} />
                                <button onClick={addPrevTask} className="bg-orange-500 text-white px-4 rounded-2xl shadow-lg font-black text-xl">＋</button>
                            </div>
                            <div className="space-y-2 pt-2">
                                {formData.prevImprovements.map(item => (
                                    <div key={item.id} className="bg-white p-4 rounded-2xl flex flex-col sm:flex-row sm:items-center justify-between gap-4 shadow-sm border border-orange-50">
                                        <div className="flex items-center gap-3"><span className="text-orange-500 font-black">✓</span><span className="text-sm font-bold text-slate-700">{item.task}</span></div>
                                        <div className="flex gap-1 shrink-0">
                                            <button onClick={() => setFormData(p => ({ ...p, prevImprovements: p.prevImprovements.map(i => i.id === item.id ? { ...i, status: 'done' } : i) }))} className={`flex-1 px-4 py-2 rounded-xl text-[10px] font-black ${item.status === 'done' ? 'bg-green-600 text-white shadow-md' : 'bg-slate-100 text-slate-400'}`}>已改善</button>
                                            <button onClick={() => setFormData(p => ({ ...p, prevImprovements: p.prevImprovements.map(i => i.id === item.id ? { ...i, status: 'pending' } : i) }))} className={`flex-1 px-4 py-2 rounded-xl text-[10px] font-black ${item.status === 'pending' ? 'bg-red-500 text-white shadow-md' : 'bg-slate-100 text-slate-400'}`}>未改善</button>
                                            <button onClick={() => setFormData(p => ({ ...p, prevImprovements: p.prevImprovements.filter(i => i.id !== item.id) }))} className="text-red-400 font-bold text-xs px-1">刪除</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>

                        {categories.map((cat) => (
                            <div key={cat} className="space-y-3">
                                <h3 className="font-black text-slate-400 text-[10px] uppercase tracking-[0.3em] px-4 border-l-2 border-slate-300 ml-1">{cat}</h3>
                                <div className="space-y-3">
                                    {formData.activeChecklist.filter(item => item.category === cat).map(item => (
                                        <div key={item.id} className="bg-white rounded-[2rem] p-6 shadow-sm border border-transparent">
                                            <p className="font-bold text-slate-700 text-sm mb-5 leading-relaxed">{item.item}</p>
                                            <div className="flex gap-2">
                                                {['差', '一般', '優'].map(s => (
                                                    <button key={s} onClick={() => setFormData({...formData, activeChecklist: formData.activeChecklist.map(i => i.id === item.id ? {...i, status: s} : i)})} className={`flex-1 py-3.5 rounded-2xl text-[10px] font-black transition-all ${item.status === s ? 'bg-slate-900 text-white shadow-xl scale-[1.05]' : 'bg-slate-100 text-slate-400'}`}>{s}</button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}

                        <section className="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-200 space-y-6">
                            <div className="flex justify-between items-center"><h2 className="font-black text-xs uppercase text-slate-400 flex items-center gap-2">● 本次缺失點</h2></div>
                            <textarea className="w-full bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold min-h-[100px] outline-none" placeholder="輸入現場缺失內容..." value={rawInput} onChange={e => setRawInput(e.target.value)} />
                            <div className="flex gap-2">
                                <button onClick={() => addDeficiency('suggest')} className="flex-1 bg-blue-100 text-blue-600 py-3 rounded-xl font-black text-xs">＋ 建議項目</button>
                                <button onClick={() => addDeficiency('require')} className="flex-1 bg-red-100 text-red-600 py-3 rounded-xl font-black text-xs">＋ 要求改善</button>
                            </div>
                            <div className="space-y-2 pt-2">
                                {formData.currentDeficiencies.map(d => (
                                    <div key={d.id} className="bg-slate-50 p-4 rounded-2xl flex items-center justify-between group border border-slate-100 text-sm font-bold">
                                        <div className="flex items-center gap-3"><div className={`w-2 h-2 rounded-full ${d.type === 'require' ? 'bg-red-500' : 'bg-blue-500'}`} />{d.task}</div>
                                        <button onClick={() => setFormData({...formData, currentDeficiencies: formData.currentDeficiencies.filter(i => i.id !== d.id)})} className="text-red-500 font-bold text-xs">刪除</button>
                                    </div>
                                ))}
                            </div>
                        </section>

                        <section className="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-200 space-y-4">
                            <div className="flex justify-between items-center"><h2 className="font-black text-[10px] uppercase text-slate-400">● 缺失照片上傳</h2><label className="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black cursor-pointer shadow-md uppercase">拍攝 / 選擇相片<input type="file" accept="image/*" multiple className="hidden" onChange={handlePhotoUpload} /></label></div>
                            {formData.photos.length > 0 ? (
                                <div className="grid grid-cols-3 gap-2">
                                    {formData.photos.map((p, i) => (
                                        <div key={i} className="relative aspect-square rounded-xl overflow-hidden shadow-sm border"><img src={p} className="w-full h-full object-cover" /><button onClick={() => setFormData({...formData, photos: formData.photos.filter((_, idx) => idx !== i)})} className="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full font-black text-[10px] flex items-center justify-center">X</button></div>
                                    ))}
                                </div>
                            ) : <div className="border-2 border-dashed border-slate-100 rounded-2xl p-8 text-center text-slate-300 text-xs font-bold italic tracking-widest uppercase">No Photos</div>}
                        </section>

                        <section className="bg-slate-900 rounded-[3rem] p-10 space-y-8 text-white shadow-2xl relative overflow-hidden border-t-8 border-blue-500">
                            <div className="text-center space-y-2 relative"><h2 className="font-black text-[10px] text-slate-500 uppercase tracking-[0.3em]">Overall Grade</h2><select className="bg-transparent text-7xl font-black text-blue-400 outline-none appearance-none text-center w-full cursor-pointer italic" value={formData.overallScore} onChange={e => setFormData({...formData, overallScore: e.target.value})}>{GRADES.map(g => <option key={g} value={g} className="bg-slate-800">{g}</option>)}</select></div>
                            <div className="space-y-4 relative">
                                <div className="flex justify-between items-center px-1"><label className="text-[10px] font-black text-slate-500 uppercase">督導建議</label><button onClick={handleAiGenerateSummary} disabled={isGeneratingSummary} className="bg-blue-600 text-white px-4 py-2 rounded-xl text-[10px] font-bold border border-blue-400 uppercase">{isGeneratingSummary ? "生成中..." : "AI 自動生成"}</button></div>
                                <textarea className="w-full bg-slate-800 border border-slate-700 rounded-3xl p-6 text-sm font-bold text-white min-h-[160px] outline-none" placeholder="評語與建議..." value={formData.overallComment} onChange={e => setFormData({...formData, overallComment: e.target.value})} />
                            </div>
                            <button onClick={handleSaveInspection} className="w-full bg-white text-slate-900 py-6 rounded-[2rem] font-black text-xl shadow-xl active:scale-95 uppercase italic hover:bg-blue-50 transition-colors uppercase italic">產出完整報告</button>
                        </section>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>




